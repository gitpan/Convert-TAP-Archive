# ABSTRACT: Read from a TAP archive and convert it for displaying

=encoding utf8

=head1 ABOUT

This modul can be of help for you if you have TAP archives (e.g. created with C<prove -a> and now you wish to have the content of this archives in a special format like HTML or JUnit (or whatever format).

=head1 SYNOPSIS

 use Convert::TAP::Archive qw(convert_from_taparchive);

 my $html = convert_from_taparchive(
                '/must/be/the/complete/path/to/test.tar.gz',
                'TAP::Formatter::HTML',
            );

=head1 EXPORTED METHODS

=head2 convert_from_taparchive

The method takes two arguments.
The first is required.
It is the B<full> path to your TAP archive.
The second defaults to C<TAP::Formatter::HTML>, but you can give any other formatter.
The method will return the content of the TAP archive, parsed according to the formatter you have specified.

 my $html = convert_from_taparchive(
                '/must/be/the/complete/path/to/test.tar.gz',
                'TAP::Formatter::HTML',
            );

You can give any optional true value as a third argument and it will pack all Javascript inside the HTML instead of linking to to files from L<TAP::Formatter::HTML>.

=head1 BUGS AND LIMITATIONS

No known issues.

=head1 SEE ALSO

=over

=item *

L<Test::Harness>

=item *

L<TAP::Formatter::Base> and its implementations for L<HTML|TAP::Formatter::HTML>, L<JUnit|TAP::Formatter::JUnit> or L<Console|TAP::Formatter::Console>.

=back

=cut

package Convert::TAP::Archive;

use strict;
use warnings;

use Capture::Tiny qw( capture_merged );
use TAP::Harness;
use TAP::Harness::Archive;
use Inline::Files;

require Exporter;
our @ISA = qw(Exporter);
our @EXPORT = qw(convert_from_taparchive);

# one and only subroutine of this module
sub convert_from_taparchive {

    # Input Arguments
    my $archive_absolutepath       = shift;
    my $output_formatter_classname = shift || 'TAP::Formatter::HTML';
    my $JS_inside_HTML         = shift || 0; # boolean

    # This is the complicate but flexible version to:
    #   use TAP::Formatter::HTML;
    #   my $formatter = TAP::Formatter::HTML->new;
    my $formatter;
    (my $require_name = $output_formatter_classname . ".pm") =~ s{::}{/}g;
    eval {
        require $require_name;
        $formatter = $output_formatter_classname->new();
    };  
    die "Problems with formatter $output_formatter_classname"
      . " at $require_name: $@"
        if $@;

    # Now we do a lot of magic to convert this stuff...

    my $harness = TAP::Harness->new({ formatter => $formatter }); 

    $formatter->really_quiet(1);
    $formatter->prepare;

    my $session;
    my $aggregator = TAP::Harness::Archive->aggregator_from_archive({ 
        archive          => $archive_absolutepath,
        parser_callbacks => {
            ALL => sub {
                $session->result( $_[0] );
            },  
        },  
        made_parser_callback => sub {
            $session = $formatter->open_test( $_[1], $_[0] );
        }   
    });

    $aggregator->start;
    $aggregator->stop;

    # This code also prints to STDOUT but we will catch it!
    my $html = capture_merged { $formatter->summary($aggregator) };

    unless ($JS_inside_HTML) {
        return $html;
    }
    else {
        my $js_script_tag = '<script type="text/javascript">';
        $js_script_tag   .= $_ while <DATA>;
        $js_script_tag   .= '</script>';

        $html =~ s/<link rel="stylesheet" type="text\/css".*default_report.css" \/>//;
        $html =~ s/<script type="text\/javascript".*default_report.css" \/>//;
        $html =~ s/<head>/<head>$js_script_tag/;

        return $html;
    }


}

1;

# TAP-Formatter-HTML: default javascript for report
# Copyright (c) 2008-2010 Steve Purkis.  All rights reserved.
# Released under the same terms as Perl itself.

__DEFJS__
jQuery.fn.extend({scrollTo:function(e,t){return this.each(function(){var n=$(this).offset().top;$("html,body").animate({scrollTop:n},e,t)})}});$(document).ready(function(){$("div.test-detail").hide();$("div#summary").find("a").click(function(){return false});$("td.file").append('<div class="back-up" style="display: none">up ↑</div>');$("td.file > div.back-up").click(function(){$(this).parent().scrollTo(1e3);return false});$("td.file").hover(function(e){var t=$(this).offset().top;var n=$(this).children("a.file");var r=$(n).height();if($(window).scrollTop()>t+r){var i=$(this).children("div.back-up");var s=e.pageY-t-r;$(i).stop().hide().css({top:s+"px",opacity:""});$(i).fadeIn()}},function(){$(this).children("div.back-up").stop().fadeOut()});$("a.file").click(function(){$(this).parents("tr:first").find("div.test-detail").slideToggle();return false});$("a.TS").click(function(){var e=$(this).parents("td.results").parents("tr:first").find("div.test-detail");e.filter(":hidden").slideDown();var t=$(this).attr("href");if(t&&t!="#"){var n=e.find(t);n.show().scrollTo(1e3);var r=n.css("background-color");n.css({backgroundColor:"yellow"});setTimeout(function(){n.css({backgroundColor:r})},3e3)}return false});$("a.TS").one("mouseover",function(){var e=$(this).attr("href");if(e&&e!="#"){var t=$(e).text();$(this).attr("title",t)}});$("#show-all").hide();$("#menu").show().fadeTo("fast","0.2").hover(function(){$(this).stop().fadeTo("fast","0.9")},function(){$(this).stop().fadeTo("fast","0.2")});$("#show-all > a").bind("click",function(){$("tr.passed").stop().fadeIn();$("#show-all").hide();$("#show-failed").show();return false});$("#show-failed > a").bind("click",function(){$("tr.passed").stop().hide();$("#show-failed").hide();$("#show-all").show();return false});if($().tablesorter){$("table.detail").tablesorter({headers:{1:{sorter:false}}})}})

# TableSorter 2.0 - Client-side table sorting with ease!
# Version 2.0.3
# @requires jQuery v1.2.3
# 
# Copyright (c) 2007 Christian Bach
# Examples and docs at: http://tablesorter.com
# Dual licensed under the MIT and GPL licenses:
# http://www.opensource.org/licenses/mit-license.php
# http://www.gnu.org/licenses/gpl.html

__JQTABLESORT__
(function($){$.extend({tablesorter:new function(){function benchmark(e,t){log(e+","+((new Date).getTime()-t.getTime())+"ms")}function log(e){if(typeof console!="undefined"&&typeof console.debug!="undefined"){console.log(e)}else{alert(e)}}function buildParserCache(e,t){if(e.config.debug){var n=""}var r=e.tBodies[0].rows;if(e.tBodies[0].rows[0]){var i=[],s=r[0].cells,o=s.length;for(var u=0;u<o;u++){var a=false;if($.metadata&&$(t[u]).metadata()&&$(t[u]).metadata().sorter){a=getParserById($(t[u]).metadata().sorter)}else if(e.config.headers[u]&&e.config.headers[u].sorter){a=getParserById(e.config.headers[u].sorter)}if(!a){a=detectParserForColumn(e,s[u])}if(e.config.debug){n+="column:"+u+" parser:"+a.id+"\n"}i.push(a)}}if(e.config.debug){log(n)}return i}function detectParserForColumn(e,t){var n=parsers.length;for(var r=1;r<n;r++){if(parsers[r].is($.trim(getElementText(e.config,t)),e,t)){return parsers[r]}}return parsers[0]}function getParserById(e){var t=parsers.length;for(var n=0;n<t;n++){if(parsers[n].id.toLowerCase()==e.toLowerCase()){return parsers[n]}}return false}function buildCache(e){if(e.config.debug){var t=new Date}var n=e.tBodies[0]&&e.tBodies[0].rows.length||0,r=e.tBodies[0].rows[0]&&e.tBodies[0].rows[0].cells.length||0,i=e.config.parsers,s={row:[],normalized:[]};for(var o=0;o<n;++o){var u=e.tBodies[0].rows[o],a=[];s.row.push($(u));for(var f=0;f<r;++f){a.push(i[f].format(getElementText(e.config,u.cells[f]),e,u.cells[f]))}a.push(o);s.normalized.push(a);a=null}if(e.config.debug){benchmark("Building cache for "+n+" rows:",t)}return s}function getElementText(e,t){if(!t)return"";var n="";if(e.textExtraction=="simple"){if(t.childNodes[0]&&t.childNodes[0].hasChildNodes()){n=t.childNodes[0].innerHTML}else{n=t.innerHTML}}else{if(typeof e.textExtraction=="function"){n=e.textExtraction(t)}else{n=$(t).text()}}return n}function appendToTable(e,t){if(e.config.debug){var n=new Date}var r=t,i=r.row,s=r.normalized,o=s.length,u=s[0].length-1,a=$(e.tBodies[0]),f=[];for(var l=0;l<o;l++){f.push(i[s[l][u]]);if(!e.config.appender){var c=i[s[l][u]];var h=c.length;for(var p=0;p<h;p++){a[0].appendChild(c[p])}}}if(e.config.appender){e.config.appender(e,f)}f=null;if(e.config.debug){benchmark("Rebuilt table:",n)}applyWidget(e);setTimeout(function(){$(e).trigger("sortEnd")},0)}function buildHeaders(e){if(e.config.debug){var t=new Date}var n=$.metadata?true:false,r=[];for(var i=0;i<e.tHead.rows.length;i++){r[i]=0}$tableHeaders=$("thead th",e);$tableHeaders.each(function(t){this.count=0;this.column=t;this.order=formatSortingOrder(e.config.sortInitialOrder);if(checkHeaderMetadata(this)||checkHeaderOptions(e,t))this.sortDisabled=true;if(!this.sortDisabled){$(this).addClass(e.config.cssHeader)}e.config.headerList[t]=this});if(e.config.debug){benchmark("Built headers:",t);log($tableHeaders)}return $tableHeaders}function checkCellColSpan(e,t,n){var r=[],i=e.tHead.rows,s=i[n].cells;for(var o=0;o<s.length;o++){var u=s[o];if(u.colSpan>1){r=r.concat(checkCellColSpan(e,headerArr,n++))}else{if(e.tHead.length==1||u.rowSpan>1||!i[n+1]){r.push(u)}}}return r}function checkHeaderMetadata(e){if($.metadata&&$(e).metadata().sorter===false){return true}return false}function checkHeaderOptions(e,t){if(e.config.headers[t]&&e.config.headers[t].sorter===false){return true}return false}function applyWidget(e){var t=e.config.widgets;var n=t.length;for(var r=0;r<n;r++){getWidgetById(t[r]).format(e)}}function getWidgetById(e){var t=widgets.length;for(var n=0;n<t;n++){if(widgets[n].id.toLowerCase()==e.toLowerCase()){return widgets[n]}}}function formatSortingOrder(e){if(typeof e!="Number"){i=e.toLowerCase()=="desc"?1:0}else{i=e==(0||1)?e:0}return i}function isValueInArray(e,t){var n=t.length;for(var r=0;r<n;r++){if(t[r][0]==e){return true}}return false}function setHeadersCss(e,t,n,r){t.removeClass(r[0]).removeClass(r[1]);var i=[];t.each(function(e){if(!this.sortDisabled){i[this.column]=$(this)}});var s=n.length;for(var o=0;o<s;o++){i[n[o][0]].addClass(r[n[o][1]])}}function fixColumnWidth(e,t){var n=e.config;if(n.widthFixed){var r=$("<colgroup>");$("tr:first td",e.tBodies[0]).each(function(){r.append($("<col>").css("width",$(this).width()))});$(e).prepend(r)}}function updateHeaderSortCount(e,t){var n=e.config,r=t.length;for(var i=0;i<r;i++){var s=t[i],o=n.headerList[s[0]];o.count=s[1];o.count++}}function multisort(table,sortList,cache){if(table.config.debug){var sortTime=new Date}var dynamicExp="var sortWrapper = function(a,b) {",l=sortList.length;for(var i=0;i<l;i++){var c=sortList[i][0];var order=sortList[i][1];var s=getCachedSortType(table.config.parsers,c)=="text"?order==0?"sortText":"sortTextDesc":order==0?"sortNumeric":"sortNumericDesc";var e="e"+i;dynamicExp+="var "+e+" = "+s+"(a["+c+"],b["+c+"]); ";dynamicExp+="if("+e+") { return "+e+"; } ";dynamicExp+="else { "}var orgOrderCol=cache.normalized[0].length-1;dynamicExp+="return a["+orgOrderCol+"]-b["+orgOrderCol+"];";for(var i=0;i<l;i++){dynamicExp+="}; "}dynamicExp+="return 0; ";dynamicExp+="}; ";eval(dynamicExp);cache.normalized.sort(sortWrapper);if(table.config.debug){benchmark("Sorting on "+sortList.toString()+" and dir "+order+" time:",sortTime)}return cache}function sortText(e,t){return e<t?-1:e>t?1:0}function sortTextDesc(e,t){return t<e?-1:t>e?1:0}function sortNumeric(e,t){return e-t}function sortNumericDesc(e,t){return t-e}function getCachedSortType(e,t){return e[t].type}var parsers=[],widgets=[];this.defaults={cssHeader:"header",cssAsc:"headerSortUp",cssDesc:"headerSortDown",sortInitialOrder:"asc",sortMultiSortKey:"shiftKey",sortForce:null,sortAppend:null,textExtraction:"simple",parsers:{},widgets:[],widgetZebra:{css:["even","odd"]},headers:{},widthFixed:false,cancelSelection:true,sortList:[],headerList:[],dateFormat:"us",decimal:".",debug:false};this.benchmark=benchmark;this.construct=function(e){return this.each(function(){if(!this.tHead||!this.tBodies)return;var t,n,r,i,s,o=0,u;this.config={};s=$.extend(this.config,$.tablesorter.defaults,e);t=$(this);r=buildHeaders(this);this.config.parsers=buildParserCache(this,r);i=buildCache(this);var a=[s.cssDesc,s.cssAsc];fixColumnWidth(this);r.click(function(e){t.trigger("sortStart");var n=t[0].tBodies[0]&&t[0].tBodies[0].rows.length||0;if(!this.sortDisabled&&n>0){var o=$(this);var u=this.column;this.order=this.count++%2;if(!e[s.sortMultiSortKey]){s.sortList=[];if(s.sortForce!=null){var f=s.sortForce;for(var l=0;l<f.length;l++){if(f[l][0]!=u){s.sortList.push(f[l])}}}s.sortList.push([u,this.order])}else{if(isValueInArray(u,s.sortList)){for(var l=0;l<s.sortList.length;l++){var c=s.sortList[l],h=s.headerList[c[0]];if(c[0]==u){h.count=c[1];h.count++;c[1]=h.count%2}}}else{s.sortList.push([u,this.order])}}setTimeout(function(){setHeadersCss(t[0],r,s.sortList,a);appendToTable(t[0],multisort(t[0],s.sortList,i))},1);return false}}).mousedown(function(){if(s.cancelSelection){this.onselectstart=function(){return false};return false}});t.bind("update",function(){this.config.parsers=buildParserCache(this,r);i=buildCache(this)}).bind("sorton",function(e,t){$(this).trigger("sortStart");s.sortList=t;var n=s.sortList;updateHeaderSortCount(this,n);setHeadersCss(this,r,n,a);appendToTable(this,multisort(this,n,i))}).bind("appendCache",function(){appendToTable(this,i)}).bind("applyWidgetId",function(e,t){getWidgetById(t).format(this)}).bind("applyWidgets",function(){applyWidget(this)});if($.metadata&&$(this).metadata()&&$(this).metadata().sortlist){s.sortList=$(this).metadata().sortlist}if(s.sortList.length>0){t.trigger("sorton",[s.sortList])}applyWidget(this)})};this.addParser=function(e){var t=parsers.length,n=true;for(var r=0;r<t;r++){if(parsers[r].id.toLowerCase()==e.id.toLowerCase()){n=false}}if(n){parsers.push(e)}};this.addWidget=function(e){widgets.push(e)};this.formatFloat=function(e){var t=parseFloat(e);return isNaN(t)?0:t};this.formatInt=function(e){var t=parseInt(e);return isNaN(t)?0:t};this.isDigit=function(e,t){var n="\\"+t.decimal;var r="/(^[+]?0("+n+"0+)?$)|(^([-+]?[1-9][0-9]*)$)|(^([-+]?((0?|[1-9][0-9]*)"+n+"(0*[1-9][0-9]*)))$)|(^[-+]?[1-9]+[0-9]*"+n+"0+$)/";return RegExp(r).test($.trim(e))};this.clearTableBody=function(e){if($.browser.msie){function t(){while(this.firstChild)this.removeChild(this.firstChild)}t.apply(e.tBodies[0])}else{e.tBodies[0].innerHTML=""}}}});$.fn.extend({tablesorter:$.tablesorter.construct});var ts=$.tablesorter;ts.addParser({id:"text",is:function(e){return true},format:function(e){return $.trim(e.toLowerCase())},type:"text"});ts.addParser({id:"digit",is:function(e,t){var n=t.config;return $.tablesorter.isDigit(e,n)},format:function(e){return $.tablesorter.formatFloat(e)},type:"numeric"});ts.addParser({id:"currency",is:function(e){return/^[£$€?.]/.test(e)},format:function(e){return $.tablesorter.formatFloat(e.replace(new RegExp(/[^0-9.]/g),""))},type:"numeric"});ts.addParser({id:"ipAddress",is:function(e){return/^\d{2,3}[\.]\d{2,3}[\.]\d{2,3}[\.]\d{2,3}$/.test(e)},format:function(e){var t=e.split("."),n="",r=t.length;for(var i=0;i<r;i++){var s=t[i];if(s.length==2){n+="0"+s}else{n+=s}}return $.tablesorter.formatFloat(n)},type:"numeric"});ts.addParser({id:"url",is:function(e){return/^(https?|ftp|file):\/\/$/.test(e)},format:function(e){return jQuery.trim(e.replace(new RegExp(/(https?|ftp|file):\/\//),""))},type:"text"});ts.addParser({id:"isoDate",is:function(e){return/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(e)},format:function(e){return $.tablesorter.formatFloat(e!=""?(new Date(e.replace(new RegExp(/-/g),"/"))).getTime():"0")},type:"numeric"});ts.addParser({id:"percent",is:function(e){return/\%$/.test($.trim(e))},format:function(e){return $.tablesorter.formatFloat(e.replace(new RegExp(/%/g),""))},type:"numeric"});ts.addParser({id:"usLongDate",is:function(e){return e.match(new RegExp(/^[A-Za-z]{3,10}\.? [0-9]{1,2}, ([0-9]{4}|'?[0-9]{2}) (([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(AM|PM)))$/))},format:function(e){return $.tablesorter.formatFloat((new Date(e)).getTime())},type:"numeric"});ts.addParser({id:"shortDate",is:function(e){return/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(e)},format:function(e,t){var n=t.config;e=e.replace(/\-/g,"/");if(n.dateFormat=="us"){e=e.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$1/$2")}else if(n.dateFormat=="uk"){e=e.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$2/$1")}else if(n.dateFormat=="dd/mm/yy"||n.dateFormat=="dd-mm-yy"){e=e.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/,"$1/$2/$3")}return $.tablesorter.formatFloat((new Date(e)).getTime())},type:"numeric"});ts.addParser({id:"time",is:function(e){return/^(([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(am|pm)))$/.test(e)},format:function(e){return $.tablesorter.formatFloat((new Date("2000/01/01 "+e)).getTime())},type:"numeric"});ts.addParser({id:"metadata",is:function(e){return false},format:function(e,t,n){var r=t.config,i=!r.parserMetadataName?"sortValue":r.parserMetadataName;return $(n).metadata()[i]},type:"numeric"});ts.addWidget({id:"zebra",format:function(e){if(e.config.debug){var t=new Date}$("tr:visible",e.tBodies[0]).filter(":even").removeClass(e.config.widgetZebra.css[1]).addClass(e.config.widgetZebra.css[0]).end().filter(":odd").removeClass(e.config.widgetZebra.css[0]).addClass(e.config.widgetZebra.css[1]);if(e.config.debug){$.tablesorter.benchmark("Applying Zebra widget",t)}}})})(jQuery)

# jQuery JavaScript Library v1.4.2
# http://jquery.com/
#
# Copyright 2010, John Resig
# Dual licensed under the MIT or GPL Version 2 licenses.
# http://jquery.org/license
#
# Includes Sizzle.js
# http://sizzlejs.com/
# Copyright 2010, The Dojo Foundation
# Released under the MIT, BSD, and GPL Licenses.
#
# Date: Sat Feb 13 22:33:48 2010 -0500

__JQ__

